<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Improve the computation efficiency of gene-gene distance matrix • GeneTrajectory</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Improve the computation efficiency of gene-gene distance matrix">
<meta property="og:description" content="GeneTrajectory">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GeneTrajectory</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/GeneTrajectory.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/fast_computation.html">Improve the computation efficiency of gene-gene distance matrix</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Improve the computation efficiency of gene-gene
distance matrix</h1>
                        <h4 data-toc-skip class="author">Rihao Qu,
Francesco Strino</h4>
            
            <h4 data-toc-skip class="date">03/20/2024</h4>
      
      
      <div class="hidden name"><code>fast_computation.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>In practice, computing the Wasserstein distance between all pairwise
gene distri- butions can be computationally expensive. When the cell
graph is large, the time cost for finding the optimal transport solution
increases exponentially. In our framework, we have designed two
strategies to accelerate the computation based on 1) cell graph
coarse-graining, and 2) gene graph sparsification. Briefly, cell graph
coarse-graining aims to reduce the cell number by aggregating nearest
cells into “meta-cells”. Gene graph sparsification aims to skip the
computation for two gene distributions if they are very far away from
each other at a coarse-grained level, as they are unlikely to
participate in the same biological process. We note that while
coarse-graining the cell graph to a crude scale can make it fast for
computation, it may lose accuracy and compromise the resolution. Hence
users should judiciously choose the level of coarse graining based on
the capacity of their computing resources.</p>
</div>
<div class="section level2">
<h2 id="preparation">Preparation<a class="anchor" aria-label="anchor" href="#preparation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##### Load required R libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">GeneTrajectory</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">plot3D</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">FNN</span><span class="op">)</span></span></code></pre></div>
<p>The preprocessed Seurat object for this tutorial can be downloaded
from <a href="https://figshare.com/articles/dataset/Processed_Seurat_objects_for_GeneTrajectory_inference_Gene_Trajectory_Inference_for_Single-cell_Data_by_Optimal_Transport_Metrics_/25243225" class="external-link">figshare</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import the tutorial dataset</span></span>
<span><span class="va">data_S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../../data/human_myeloid_seurat_obj.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># In this tutorial, we demonstrate gene-gene distance computation by selecting the genes expressed by 1% to 50% of cells among the top 500 variable genes. </span></span>
<span><span class="va">assay</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">data_S</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">assay</span></span>
<span><span class="va">data_S</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">data_S</span>, nfeatures <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">all_genes</span> <span class="op">&lt;-</span> <span class="va">data_S</span><span class="op">@</span><span class="va">assays</span><span class="op">[[</span><span class="va">assay</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">var.features</span></span>
<span><span class="va">expr_percent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data_S</span><span class="op">[[</span><span class="va">assay</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">all_genes</span>, <span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data_S</span><span class="op">)</span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="va">all_genes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">expr_percent</span> <span class="op">&gt;</span> <span class="fl">0.01</span> <span class="op">&amp;</span> <span class="va">expr_percent</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">genes</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 251</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute the Diffusion Map cell embedding</span></span>
<span><span class="va">data_S</span> <span class="op">&lt;-</span> <span class="fu">GeneTrajectory</span><span class="fu">::</span><span class="fu"><a href="../reference/RunDM.html">RunDM</a></span><span class="op">(</span><span class="va">data_S</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate cell-cell graph distances over a cell-cell kNN graph</span></span>
<span><span class="va">cell.graph.dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetGraphDistance.html">GetGraphDistance</a></span><span class="op">(</span><span class="va">data_S</span>, K <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Constructing kNN graph</span></span></code></pre>
<pre><code><span><span class="co">## Constructing graph distance matrix</span></span></code></pre>
<pre><code><span><span class="co">## The largest graph distance is 35</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a virtualenv using reticulate for gene-gene distance computation</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/virtualenv-tools.html" class="external-link">virtualenv_exists</a></span><span class="op">(</span><span class="st">'gene_trajectory'</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/virtualenv-tools.html" class="external-link">virtualenv_create</a></span><span class="op">(</span><span class="st">'gene_trajectory'</span>, packages<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'gene_trajectory'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/use_python.html" class="external-link">use_virtualenv</a></span><span class="op">(</span><span class="st">'gene_trajectory'</span><span class="op">)</span></span>
<span><span class="co"># Import the function to compute gene-gene distances</span></span>
<span><span class="va">cal_ot_mat_from_numpy</span> <span class="op">&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="st">'gene_trajectory.compute_gene_distance_cmd'</span><span class="op">)</span><span class="op">$</span><span class="va">cal_ot_mat_from_numpy</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="strategy-1-cell-graph-coarse-graining">Strategy-1: cell graph coarse-graining<a class="anchor" aria-label="anchor" href="#strategy-1-cell-graph-coarse-graining"></a>
</h2>
<p>To improve computation efficiency, we coarse-grain the cell graph by
grouping cells into <code>N</code> “meta-cells”.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: coarse-grain the cell graph by grouping cells into `N`=500 "meta-cells"</span></span>
<span><span class="va">cg_output1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoarseGrain.html">CoarseGrain</a></span><span class="op">(</span><span class="va">data_S</span>, <span class="va">cell.graph.dist</span>, <span class="va">genes</span>, N <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">gene.dist.mat1</span> <span class="op">&lt;-</span> <span class="fu">cal_ot_mat_from_numpy</span><span class="op">(</span>ot_cost <span class="op">=</span> <span class="va">cg_output1</span><span class="op">[[</span><span class="st">"graph.dist"</span><span class="op">]</span><span class="op">]</span>, gene_expr <span class="op">=</span> <span class="va">cg_output1</span><span class="op">[[</span><span class="st">"gene.expression"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example: coarse-grain the cell graph by grouping cells into `N`=1000 "meta-cells", which will take a longer time to complete as compared with using `N`=500 "meta-cells". However, it can better preserve the local geometry of the cell graph.</span></span>
<span><span class="va">cg_output2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoarseGrain.html">CoarseGrain</a></span><span class="op">(</span><span class="va">data_S</span>, <span class="va">cell.graph.dist</span>, <span class="va">genes</span>, N <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">gene.dist.mat2</span> <span class="op">&lt;-</span> <span class="fu">cal_ot_mat_from_numpy</span><span class="op">(</span>ot_cost <span class="op">=</span> <span class="va">cg_output2</span><span class="op">[[</span><span class="st">"graph.dist"</span><span class="op">]</span><span class="op">]</span>, gene_expr <span class="op">=</span> <span class="va">cg_output2</span><span class="op">[[</span><span class="st">"gene.expression"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="strategy-2-gene-graph-sparsification">Strategy-2: gene graph sparsification<a class="anchor" aria-label="anchor" href="#strategy-2-gene-graph-sparsification"></a>
</h2>
<p>We sparsify the gene affinity graph by zeroing out the entries where
their pairwise Wasserstein distances are greater than a threshold. The
threshold is selected such that affinities associated with distances
greater than it will be exponentially small and thus contribute
negligibly to the gene affinity graph. The threshold is adaptively
estimated for each cell using the approximate Wasserstein distance on a
coarse-grained cell graph (Strategy 1) which allows fast
computation.</p>
<p>Specifically, this is formulated in the following way: if we want to
construct the gene-gene Wasserstein distance matrix on a cell graph of a
size <span class="math inline">\(m\)</span>, we first coarse-grain <span class="math inline">\(m\)</span> cells into <span class="math inline">\(m′\)</span> “meta-cells” using the procedure in
Strategy 1 where <span class="math inline">\(m′\)</span> is a size that
can be quickly handled. Based on the gene-by-gene Wasserstein distance
matrix constructed on <span class="math inline">\(m′\)</span>
“meta-cells”, we identify the <span class="math inline">\(αk\)</span>
nearest neighbors for each gene (where <span class="math inline">\(α\)</span> is the predefined parameter (ideally,
choosing <span class="math inline">\(α \geq k\)</span>) and <span class="math inline">\(k\)</span> is the neighborhood size to construct
the local adaptive kernel for computing the gene Diffusion Map embedding
in the next step). Going back to the computation on the original cell
graph, we then only compute the Wasserstein distance between a pair of
genes if one of them is included in the other’s <span class="math inline">\(αk\)</span> nearest neighbors. Practically, this
can reduce the running time to <span class="math inline">\(2αk/m\)</span> of the original which computes
Wasserstein distances for all pairs of genes.</p>
<p>Below shows an example of computing gene-gene distances over the
original cell graph, utilizing the precomputed gene-gene distance matrix
on <code>N</code> = 500. Here, we choose <span class="math inline">\(α=5\)</span>, <span class="math inline">\(K=5\)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">K</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">knn.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FNN/man/get.knn.html" class="external-link">get.knn</a></span><span class="op">(</span><span class="va">gene.dist.mat1</span>, k<span class="op">=</span><span class="va">alpha</span><span class="op">*</span><span class="va">K</span><span class="op">)</span><span class="op">$</span><span class="va">nn.index</span> </span>
<span><span class="va">gene.pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">knn.index</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">knn.index</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">knn.index</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gene.pairs</span> <span class="op">&lt;-</span> <span class="va">gene.pairs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">gene.pairs</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">gene.pairs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="va">gene.dist.mat3</span> <span class="op">&lt;-</span> <span class="fu">cal_ot_mat_from_numpy</span><span class="op">(</span>ot_cost <span class="op">=</span> <span class="va">cell.graph.dist</span>, gene_expr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">data_S</span><span class="op">[[</span><span class="va">assay</span><span class="op">]</span><span class="op">]</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">genes</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>, gene_pairs <span class="op">=</span> <span class="va">gene.pairs</span><span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="co"># Here, using -1L is to match the indexing criterion in Python.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="comparing-gene-embeddings">Comparing gene embeddings<a class="anchor" aria-label="anchor" href="#comparing-gene-embeddings"></a>
</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Construct the gene embedding by employing Diffusion Map</span></span>
<span><span class="va">gene_embedding1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetGeneEmbedding.html">GetGeneEmbedding</a></span><span class="op">(</span><span class="va">gene.dist.mat1</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">$</span><span class="va">diffu.emb</span></span>
<span><span class="va">gene_embedding2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetGeneEmbedding.html">GetGeneEmbedding</a></span><span class="op">(</span><span class="va">gene.dist.mat2</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">$</span><span class="va">diffu.emb</span></span>
<span><span class="va">gene_embedding3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetGeneEmbedding.html">GetGeneEmbedding</a></span><span class="op">(</span><span class="va">gene.dist.mat3</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">$</span><span class="va">diffu.emb</span></span>
<span></span>
<span><span class="co"># Extract gene trajectories using gene_embedding1 and project onto gene_embedding2 and gene_embedding3 for visual comparison</span></span>
<span><span class="va">gene_trajectory</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ExtractGeneTrajectory.html">ExtractGeneTrajectory</a></span><span class="op">(</span><span class="va">gene_embedding1</span>, <span class="va">gene.dist.mat1</span>, N <span class="op">=</span> <span class="fl">3</span>, t.list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">7</span>,<span class="fl">7</span><span class="op">)</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize gene_embedding1</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/plot3D/man/scatter.html" class="external-link">scatter3D</a></span><span class="op">(</span><span class="va">gene_embedding1</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>          <span class="va">gene_embedding1</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>          <span class="va">gene_embedding1</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>,</span>
<span>          bty <span class="op">=</span> <span class="st">"b2"</span>, colvar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gene_trajectory</span><span class="op">$</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>          main <span class="op">=</span> <span class="st">"Gene Embedding 1"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">1</span>, theta <span class="op">=</span> <span class="fl">45</span>, phi <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/plot3D/man/colors.html" class="external-link">ramp.col</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://scales.r-lib.org/reference/hue_pal.html" class="external-link">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="fast_computation_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize gene_embedding2</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/plot3D/man/scatter.html" class="external-link">scatter3D</a></span><span class="op">(</span><span class="va">gene_embedding2</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>          <span class="va">gene_embedding2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>          <span class="va">gene_embedding2</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>,</span>
<span>          bty <span class="op">=</span> <span class="st">"b2"</span>, colvar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gene_trajectory</span><span class="op">$</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>          main <span class="op">=</span> <span class="st">"Gene Embedding 2"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">1</span>, theta <span class="op">=</span> <span class="fl">45</span>, phi <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/plot3D/man/colors.html" class="external-link">ramp.col</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://scales.r-lib.org/reference/hue_pal.html" class="external-link">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="fast_computation_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize gene_embedding3</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/plot3D/man/scatter.html" class="external-link">scatter3D</a></span><span class="op">(</span><span class="va">gene_embedding3</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>          <span class="va">gene_embedding3</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>          <span class="va">gene_embedding3</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span>,</span>
<span>          bty <span class="op">=</span> <span class="st">"b2"</span>, colvar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gene_trajectory</span><span class="op">$</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>          main <span class="op">=</span> <span class="st">"Gene Embedding 3"</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex <span class="op">=</span> <span class="fl">1</span>, theta <span class="op">=</span> <span class="fl">45</span>, phi <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/plot3D/man/colors.html" class="external-link">ramp.col</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://scales.r-lib.org/reference/hue_pal.html" class="external-link">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="fast_computation_files/figure-html/unnamed-chunk-6-3.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.1 (2023-06-16)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 22.04.3 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.10.0 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.so.3;  LAPACK version 3.10.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/New_York</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] FNN_1.1.3.2          plot3D_1.4           Matrix_1.6-0        </span></span>
<span><span class="co">##  [4] GeneTrajectory_1.0.0 dplyr_1.1.3          viridis_0.6.4       </span></span>
<span><span class="co">##  [7] viridisLite_0.4.2    ggplot2_3.4.3        scales_1.2.1        </span></span>
<span><span class="co">## [10] SeuratObject_4.1.3   Seurat_4.3.0.1      </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RColorBrewer_1.1-3     rstudioapi_0.15.0      jsonlite_1.8.7        </span></span>
<span><span class="co">##   [4] magrittr_2.0.3         spatstat.utils_3.0-3   farver_2.1.1          </span></span>
<span><span class="co">##   [7] rmarkdown_2.24         fs_1.6.3               ragg_1.2.5            </span></span>
<span><span class="co">##  [10] vctrs_0.6.3            ROCR_1.0-11            memoise_2.0.1         </span></span>
<span><span class="co">##  [13] spatstat.explore_3.2-3 htmltools_0.5.6        sass_0.4.7            </span></span>
<span><span class="co">##  [16] sctransform_0.3.5      parallelly_1.36.0      KernSmooth_2.23-22    </span></span>
<span><span class="co">##  [19] bslib_0.5.1            htmlwidgets_1.6.2      desc_1.4.2            </span></span>
<span><span class="co">##  [22] ica_1.0-3              plyr_1.8.8             plotly_4.10.2         </span></span>
<span><span class="co">##  [25] zoo_1.8-12             cachem_1.0.8           misc3d_0.9-1          </span></span>
<span><span class="co">##  [28] igraph_1.5.1           mime_0.12              lifecycle_1.0.3       </span></span>
<span><span class="co">##  [31] pkgconfig_2.0.3        R6_2.5.1               fastmap_1.1.1         </span></span>
<span><span class="co">##  [34] fitdistrplus_1.1-11    future_1.33.0          shiny_1.7.5           </span></span>
<span><span class="co">##  [37] digest_0.6.33          rARPACK_0.11-0         colorspace_2.1-0      </span></span>
<span><span class="co">##  [40] patchwork_1.1.3        rprojroot_2.0.3        tensor_1.5            </span></span>
<span><span class="co">##  [43] RSpectra_0.16-1        irlba_2.3.5.1          textshaping_0.3.6     </span></span>
<span><span class="co">##  [46] progressr_0.14.0       fansi_1.0.4            spatstat.sparse_3.0-2 </span></span>
<span><span class="co">##  [49] httr_1.4.7             polyclip_1.10-4        abind_1.4-5           </span></span>
<span><span class="co">##  [52] compiler_4.3.1         withr_2.5.0            highr_0.10            </span></span>
<span><span class="co">##  [55] MASS_7.3-60            tools_4.3.1            lmtest_0.9-40         </span></span>
<span><span class="co">##  [58] httpuv_1.6.11          future.apply_1.11.0    goftest_1.2-3         </span></span>
<span><span class="co">##  [61] glue_1.6.2             nlme_3.1-162           promises_1.2.1        </span></span>
<span><span class="co">##  [64] grid_4.3.1             Rtsne_0.16             cluster_2.1.4         </span></span>
<span><span class="co">##  [67] reshape2_1.4.4         generics_0.1.3         gtable_0.3.4          </span></span>
<span><span class="co">##  [70] spatstat.data_3.0-1    tidyr_1.3.0            data.table_1.14.8     </span></span>
<span><span class="co">##  [73] sp_2.0-0               utf8_1.2.3             spatstat.geom_3.2-5   </span></span>
<span><span class="co">##  [76] RcppAnnoy_0.0.21       ggrepel_0.9.3          RANN_2.6.1            </span></span>
<span><span class="co">##  [79] pillar_1.9.0           stringr_1.5.0          later_1.3.1           </span></span>
<span><span class="co">##  [82] splines_4.3.1          lattice_0.21-8         survival_3.5-5        </span></span>
<span><span class="co">##  [85] deldir_1.0-9           tidyselect_1.2.0       miniUI_0.1.1.1        </span></span>
<span><span class="co">##  [88] pbapply_1.7-2          knitr_1.43             gridExtra_2.3         </span></span>
<span><span class="co">##  [91] scattermore_1.2        xfun_0.40              matrixStats_1.0.0     </span></span>
<span><span class="co">##  [94] stringi_1.7.12         lazyeval_0.2.2         yaml_2.3.7            </span></span>
<span><span class="co">##  [97] evaluate_0.21          codetools_0.2-19       tcltk_4.3.1           </span></span>
<span><span class="co">## [100] tibble_3.2.1           cli_3.6.1              uwot_0.1.16           </span></span>
<span><span class="co">## [103] xtable_1.8-4           reticulate_1.35.0      systemfonts_1.0.4     </span></span>
<span><span class="co">## [106] munsell_0.5.0          jquerylib_0.1.4        Rcpp_1.0.11           </span></span>
<span><span class="co">## [109] globals_0.16.2         spatstat.random_3.1-6  png_0.1-8             </span></span>
<span><span class="co">## [112] parallel_4.3.1         ellipsis_0.3.2         pkgdown_2.0.7         </span></span>
<span><span class="co">## [115] listenv_0.9.0          ggridges_0.5.4         leiden_0.4.3          </span></span>
<span><span class="co">## [118] purrr_1.0.2            rlang_1.1.1            cowplot_1.1.1</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rihao Qu, Francesco Strino.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
